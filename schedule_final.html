<!DOCTYPE html>
<html lang="ar" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Garde - DSP Ghardaïa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Tajawal', sans-serif; background: #e5e7eb; }
        
        /* A4 Landscape Configuration */
        @page {
            size: A4 landscape;
            margin: 0;
        }

        .page {
            width: 297mm; /* A4 Landscape width */
            height: 210mm; /* A4 Landscape height */
            margin: 20px auto;
            background: white;
            padding: 10mm 15mm;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden; /* Prevent overflow */
            display: flex;
            flex-direction: column;
        }

        /* Screen Preview Adjustments */
        @media screen {
            .page {
                height: auto;
                min-height: 210mm;
            }
        }

        /* Print Adjustments */
        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            .page {
                margin: 0;
                box-shadow: none;
                page-break-after: always;
                width: 100%;
                height: 100%;
            }
        }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th, td { border: 1px solid #000; text-align: center; padding: 1px; height: 20px; }
        th { background-color: #f3f4f6; padding: 4px; font-weight: 800; }
        
        /* Day Types Colors */
        .weekend { background-color: #e5e7eb; } /* Grey */
        .holiday { background-color: #fca5a5; } /* Red */
        
        /* Inputs */
        select.cell-select {
            width: 100%; height: 100%; border: none; background: transparent;
            text-align: center; text-align-last: center; font-size: 11px; font-weight: 600;
            appearance: none; cursor: pointer; outline: none;
        }
        select.cell-select:hover { background: #f9fafb; }
        
        /* Stats Table */
        .stats-table th { background: #1f2937; color: white; font-size: 10px; }
        .stats-table td { font-size: 10px; font-weight: bold; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden">

    <aside class="no-print w-full md:w-80 bg-white shadow-xl z-20 flex flex-col h-full overflow-hidden">
        <div class="p-4 bg-blue-900 text-white shadow-md">
            <h1 class="text-lg font-bold">Garde Manager</h1>
            <p class="text-xs text-blue-200">DSP Ghardaïa</p>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-6">
            <div class="bg-slate-50 p-3 rounded border">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Période</label>
                <div class="flex gap-2">
                    <select id="monthSelect" class="w-full border p-1 rounded text-sm"></select>
                    <input type="number" id="yearInput" class="w-20 border p-1 rounded text-sm text-center" value="2025">
                </div>
            </div>

            <div class="bg-slate-50 p-3 rounded border flex flex-col h-64">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Médecins / Infirmiers</label>
                <div class="flex gap-1 mb-2">
                    <input type="text" id="newDocName" placeholder="Ajouter nom..." class="flex-1 border p-1 rounded text-sm" onkeypress="handleEnter(event)">
                    <button onclick="addDoctor()" class="bg-blue-600 text-white px-3 rounded font-bold hover:bg-blue-700">+</button>
                </div>
                <div id="doctorList" class="flex-1 overflow-y-auto space-y-1 pr-1">
                    </div>
            </div>

            <div class="bg-slate-50 p-3 rounded border">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Colonnes (Gardes)</label>
                <div id="columnList" class="space-y-2 mb-2"></div>
                <button onclick="addColumn()" class="w-full text-xs text-blue-600 border border-dashed border-blue-400 p-1 rounded hover:bg-blue-50">+ Ajouter Colonne</button>
            </div>
            
            <button onclick="generateGrid()" class="w-full bg-green-600 text-white py-2 rounded font-bold shadow hover:bg-green-700">Actualiser / Reset</button>
        </div>

        <div class="p-4 border-t bg-gray-100">
            <button onclick="window.print()" class="w-full bg-gray-800 text-white py-3 rounded font-bold hover:bg-black flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                Imprimer (A4)
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-auto bg-gray-300 p-4 md:p-8 flex justify-center items-start">
        
        <div class="page">
            
            <header class="text-center mb-4">
                <h3 class="text-xs font-bold text-gray-600 uppercase">République Algérienne Démocratique et Populaire</h3>
                <h3 class="text-xs font-bold text-gray-600 uppercase">Ministère de la Santé</h3>
                <h2 class="text-sm font-extrabold text-black uppercase mt-1">Direction de la Santé et de la Population de Ghardaïa</h2>
                <h3 class="text-xs font-bold text-gray-700" contenteditable="true">Etablissement Public de Santé de Proximité - Berriane</h3>
                
                <div class="mt-3 border-b-2 border-black pb-1 mb-1 inline-block">
                    <h1 class="text-2xl font-black uppercase tracking-wide">Tableau de Garde</h1>
                </div>
                <div>
                    <span id="displayMonth" class="text-sm font-bold bg-gray-100 px-3 py-1 rounded border border-gray-300">Décembre 2025</span>
                </div>
            </header>

            <div class="flex-1 w-full">
                <table id="scheduleTable">
                    <thead>
                        <tr id="tableHeaderRow">
                            <th class="w-8">J</th>
                            <th class="w-8">Date</th>
                            </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>

            <div class="mt-4 flex gap-4 h-32">
                
                <div class="w-1/3 border border-gray-300 rounded p-1 overflow-hidden">
                    <h4 class="text-[10px] font-bold bg-gray-100 text-center border-b mb-1">Récapitulatif des Gardes</h4>
                    <div class="overflow-y-auto h-full pb-4">
                        <table class="stats-table w-full">
                            <thead>
                                <tr>
                                    <th class="text-left pl-2">Nom</th>
                                    <th>Sem</th>
                                    <th>WE</th>
                                    <th>Férié</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody id="statsBody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="w-2/3 flex justify-around items-end pb-4">
                    <div class="text-center">
                        <p class="text-xs font-bold mb-8">Le Chef de Service</p>
                        <p class="text-[10px] text-gray-400">Signature</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs font-bold mb-8">Le Médecin Coordinateur</p>
                        <p class="text-[10px] text-gray-400">Signature</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs font-bold mb-8">Le Directeur</p>
                        <p class="text-[10px] text-gray-400">Signature</p>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-2 right-4 text-[9px] text-gray-500">
                Fait à Berriane, le <span id="printDate"></span>
            </div>
        </div>

    </main>

    <script>
        // --- Data & Config ---
        const months = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
        const daysShort = ["Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam"];
        
        let doctors = ["Dr. Bouslama", "Dr. Ben Dib", "Dr. Djellali", "Dr. Sahri", "Dr. Hennous", "Dr. Hammadi"];
        let columns = [{ title: "08:00 - 20:00" }, { title: "20:00 - 08:00" }]; // Night shift is usually index 1

        // Holidays (Fixed & Estimated Islamic 2025/26)
        const holidays = {
            "0-1": "Jour de l'An", "0-12": "Yennayer", "4-1": "Fête du Travail", 
            "6-5": "Indépendance", "10-1": "Révolution",
            // 2025 Estimates
            "2-30": "Aïd Fitr", "2-31": "Aïd Fitr", "5-6": "Aïd Adha", "5-7": "Aïd Adha", 
            "5-27": "Awal Moharram", "6-6": "Achoura", "8-5": "Mawlid"
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            const mSelect = document.getElementById('monthSelect');
            months.forEach((m, i) => mSelect.add(new Option(m, i)));
            
            const now = new Date();
            mSelect.value = now.getMonth();
            document.getElementById('yearInput').value = now.getFullYear();
            document.getElementById('printDate').innerText = now.toLocaleDateString('fr-FR');

            renderSidebar();
            generateGrid();
        });

        // --- Logic ---
        function generateGrid() {
            const mIndex = parseInt(document.getElementById('monthSelect').value);
            const year = parseInt(document.getElementById('yearInput').value);
            
            document.getElementById('displayMonth').innerText = `${months[mIndex]} ${year}`;

            // Build Header
            const thead = document.getElementById('tableHeaderRow');
            thead.innerHTML = `<th class="w-8 bg-gray-100">J</th><th class="w-8 bg-gray-100">Date</th>`;
            columns.forEach(col => {
                const th = document.createElement('th');
                th.innerHTML = `<input value="${col.title}" class="w-full bg-transparent text-center font-bold outline-none" onchange="this.value = this.value">`;
                thead.appendChild(th);
            });

            // Build Body
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const daysInMonth = new Date(year, mIndex + 1, 0).getDate();
            
            let docOptions = `<option value="">-</option>` + doctors.map(d => `<option value="${d}">${d}</option>`).join('');

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, mIndex, d);
                const dayIdx = date.getDay();
                const hKey = `${mIndex}-${d}`;
                const isHoliday = holidays[hKey];
                const isWeekend = (dayIdx === 5 || dayIdx === 6); // Fri/Sat

                const tr = document.createElement('tr');
                tr.dataset.type = isHoliday ? 'holiday' : (isWeekend ? 'weekend' : 'workday');
                
                if (isHoliday) tr.classList.add('holiday');
                else if (isWeekend) tr.classList.add('weekend');

                // Day Name
                tr.innerHTML = `
                    <td class="font-bold text-gray-700">${daysShort[dayIdx]}</td>
                    <td class="font-bold">${d < 10 ? '0'+d : d}</td>
                `;

                // Columns
                columns.forEach(() => {
                    const td = document.createElement('td');
                    td.innerHTML = `<select class="cell-select" onchange="calculateStats()">${docOptions}</select>`;
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            }
            calculateStats();
        }

        function calculateStats() {
            // Stats Object: { "Dr.Name": { work: 0, weekend: 0, holiday: 0 } }
            let stats = {};
            doctors.forEach(d => stats[d] = { work: 0, weekend: 0, holiday: 0, total: 0 });

            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const type = row.dataset.type; // workday, weekend, holiday
                // We specifically look at the SECOND column (20:00-08:00) if user wants that specific count
                // Or we count ALL. The user said "calculate number of gard (20:00 - 08:00)".
                // Usually this is the 2nd column (index 1 in inputs).
                
                const selects = row.querySelectorAll('select');
                
                // Let's count specifically the column labeled "20:00 - 08:00" if possible, 
                // or just count all if the user named them differently.
                // For simplicity/robustness, I will count ALL shifts in the row. 
                // If you want ONLY the night shift, we can limit this loop.
                
                selects.forEach((sel, index) => {
                    // Filter: Uncomment next line to ONLY count the 2nd column (Index 1)
                    // if (index !== 1) return; 

                    const doc = sel.value;
                    if (doc && stats[doc]) {
                        if (type === 'holiday') stats[doc].holiday++;
                        else if (type === 'weekend') stats[doc].weekend++;
                        else stats[doc].work++;
                        stats[doc].total++;
                    }
                });
            });

            // Render Stats
            const sBody = document.getElementById('statsBody');
            sBody.innerHTML = '';
            
            Object.keys(stats).forEach(doc => {
                const s = stats[doc];
                if (s.total > 0) {
                    sBody.innerHTML += `
                        <tr class="border-b">
                            <td class="text-left pl-2 text-blue-800">${doc}</td>
                            <td>${s.work}</td>
                            <td>${s.weekend}</td>
                            <td class="text-red-600">${s.holiday}</td>
                            <td class="bg-gray-100">${s.total}</td>
                        </tr>
                    `;
                }
            });
        }

        // --- Sidebar Management ---
        function renderSidebar() {
            const list = document.getElementById('doctorList');
            list.innerHTML = doctors.map((d, i) => `
                <div class="flex justify-between items-center bg-white p-1 mb-1 rounded border shadow-sm">
                    <span class="text-xs font-bold">${d}</span>
                    <button onclick="removeDoc(${i})" class="text-red-500 font-bold px-1 hover:bg-red-50">×</button>
                </div>
            `).join('');

            const colList = document.getElementById('columnList');
            colList.innerHTML = columns.map((c, i) => `
                <div class="flex gap-1 mb-1">
                    <input value="${c.title}" onchange="columns[${i}].title=this.value; generateGrid()" class="flex-1 text-xs border p-1 rounded">
                    <button onclick="removeCol(${i})" class="text-red-500 text-xs">×</button>
                </div>
            `).join('');
        }

        function addDoctor() {
            const val = document.getElementById('newDocName').value.trim();
            if(val) { doctors.push(val); document.getElementById('newDocName').value=''; renderSidebar(); generateGrid(); }
        }
        function removeDoc(i) { doctors.splice(i, 1); renderSidebar(); generateGrid(); }
        function handleEnter(e) { if(e.key === 'Enter') addDoctor(); }

        function addColumn() { columns.push({title: 'Nouveau'}); renderSidebar(); generateGrid(); }
        function removeCol(i) { if(columns.length > 1) { columns.splice(i, 1); renderSidebar(); generateGrid(); }}

    </script>
</body>
</html>
